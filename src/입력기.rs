// kiwiyouë‹˜ ì œê³µ

use crate::ê°€ëª…::*;

#[derive(ë³µì œ, ë””ë²„ê·¸, ë¶€ë¶„ê°™ìŒ)]
pub enum ì•„í¬ì…ë ¥ì˜¤ë¥˜ {
    íŒŒì¼ë,
    ìŠ¤íŠ¸ë¦¼ë§‰í˜,
    Utf8ì•„ë‹˜,
    I64ì•„ë‹˜,
}

#[derive(ë³µì œ)]
pub struct ì•„í¬ì…ë ¥ê¸°<ã…‡: ì½ìŒ> {
    ë²„í¼: ë²¡<u8>,
    ë°©ê¸ˆ_ì½ì€_í¬ê¸°: uí¬ê¸°,
    ì˜¤í”„ì…‹: uí¬ê¸°,
    ìŠ¤íŠ¸ë¦¼: ã…‡,
}

impl<ã…‡: ì½ìŒ> ì•„í¬ì…ë ¥ê¸°<ã…‡> {
    pub fn ìƒˆ(ë²„í¼í¬ê¸°: uí¬ê¸°, ìŠ¤íŠ¸ë¦¼: ã…‡) -> Self {
        Self {
            ë²„í¼: vec![0; ë²„í¼í¬ê¸°],
            ë°©ê¸ˆ_ì½ì€_í¬ê¸°: 0,
            ì˜¤í”„ì…‹: 0,
            ìŠ¤íŠ¸ë¦¼,
        }
    }

    fn ë²„í¼ì—_ì½ê¸°(&mut self) -> Result<uí¬ê¸°, ì•„í¬ì…ë ¥ì˜¤ë¥˜> {
        let ì¢‹ìŒ(ìˆ˜) = self.ìŠ¤íŠ¸ë¦¼.read(&mut self.ë²„í¼) else {
			return ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::ìŠ¤íŠ¸ë¦¼ë§‰í˜);
		};
        self.ë°©ê¸ˆ_ì½ì€_í¬ê¸° = ìˆ˜;
        if ìˆ˜ == 0 {
            return ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::íŒŒì¼ë);
        }
        ì¢‹ìŒ(ìˆ˜)
    }

    fn ë°”ì´íŠ¸_ë³´ê¸°(&mut self) -> Result<u8, ì•„í¬ì…ë ¥ì˜¤ë¥˜> {
        if self.ì˜¤í”„ì…‹ == self.ë°©ê¸ˆ_ì½ì€_í¬ê¸° {
            self.ì˜¤í”„ì…‹ = 0;
            self.ë²„í¼ì—_ì½ê¸°()?;
        }
        ì¢‹ìŒ(self.ë²„í¼[self.ì˜¤í”„ì…‹])
    }

    fn ë°”ì´íŠ¸_ì½ê¸°(&mut self) -> Result<u8, ì•„í¬ì…ë ¥ì˜¤ë¥˜> {
        let ë°” = self.ë°”ì´íŠ¸_ë³´ê¸°()?;
        self.ì˜¤í”„ì…‹ += 1;
        ì¢‹ìŒ(ë°”)
    }

    pub fn ë¬¸ì_ì½ê¸°(&mut self) -> Result<char, ì•„í¬ì…ë ¥ì˜¤ë¥˜> {
        let ë°” = self.ë°”ì´íŠ¸_ì½ê¸°()?;
        match ë°”.leading_ones() {
            0 => {
                ì¢‹ìŒ(ë°” as char)
            }
            ê¸¸ì´ @ (2..=4) => {
                let mut ì½”ë“œ: u32 = (ë°” & 0b1111) as u32;
                for _ in 0..ê¸¸ì´ - 1 {
                    let ë°” = self.ë°”ì´íŠ¸_ì½ê¸°()?;
                    if ë°” & 0b10000000 == 0 {
                        return ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::Utf8ì•„ë‹˜);
                    }
                    ì½”ë“œ = ì½”ë“œ << 6 | (ë°” & 0b111111) as u32;
                }
                char::from_u32(ì½”ë“œ).ok_or(ì•„í¬ì…ë ¥ì˜¤ë¥˜::Utf8ì•„ë‹˜)
            }
            _ => {
                ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::Utf8ì•„ë‹˜)
            }
        }
    }

    pub fn ì •ìˆ˜_ì½ê¸°(&mut self) -> Result<i64, ì•„í¬ì…ë ¥ì˜¤ë¥˜> {
        let mut ë¬¸ìì—´ = ë¬¸ìì—´::new();

        let mut ë°” = self.ë°”ì´íŠ¸_ì½ê¸°()?;
        while ë°” <= b' ' {
            ë°” = self.ë°”ì´íŠ¸_ì½ê¸°()?;
        }
        while ë°” > b' ' {
            ë¬¸ìì—´.push(ë°” as char);
            ë°” = self.ë°”ì´íŠ¸_ì½ê¸°()?;
        }
        ë¬¸ìì—´.parse::<i64>().map_err(|_| ì•„í¬ì…ë ¥ì˜¤ë¥˜::I64ì•„ë‹˜)
    }
}

#[cfg(test)]
mod í…ŒìŠ¤íŠ¸ {
    use super::*;

    #[test]
    fn í…ŒìŠ¤íŠ¸_ì…ë ¥_ì•„ìŠ¤í‚¤() {
        let mut ì…ë ¥ê¸° = ì•„í¬ì…ë ¥ê¸°::<&[u8]>::ìƒˆ(100, "ah U\n3?".as_bytes());
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('a'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('h'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ(' '));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('U'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('\n'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('3'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('?'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::íŒŒì¼ë));
    }

    #[test]
    fn í…ŒìŠ¤íŠ¸_ì…ë ¥_ìœ ë‹ˆì½”ë“œ() {
        // í¬æ€’ â™¥ğŸ¥Œ
        let mut ì…ë ¥ê¸° = ì•„í¬ì…ë ¥ê¸°::<&[u8]>::ìƒˆ(
            100,
            &[
                237, 157, 172, 230, 128, 146, 32, 226, 153, 165, 240, 159, 165, 140,
            ],
        );
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('í¬'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('æ€’'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ(' '));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('â™¥'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì¢‹ìŒ('ğŸ¥Œ'));
        assert_eq!(ì…ë ¥ê¸°.ë¬¸ì_ì½ê¸°(), ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::íŒŒì¼ë));
    }

    #[test]
    fn í…ŒìŠ¤íŠ¸_ì…ë ¥_ì •ìˆ˜() {
        let mut ì…ë ¥ê¸° = ì•„í¬ì…ë ¥ê¸°::<&[u8]>::ìƒˆ(
            100,
            " 1 203456789012345   -3479897897878   \n\t  0 0050 -05\t\t".as_bytes(),
        );
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì¢‹ìŒ(1));
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì¢‹ìŒ(203456789012345));
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì¢‹ìŒ(-3479897897878));
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì¢‹ìŒ(0));
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì¢‹ìŒ(50));
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì¢‹ìŒ(-5));
        assert_eq!(ì…ë ¥ê¸°.ì •ìˆ˜_ì½ê¸°(), ì—ëŸ¬(ì•„í¬ì…ë ¥ì˜¤ë¥˜::íŒŒì¼ë));
    }
}
